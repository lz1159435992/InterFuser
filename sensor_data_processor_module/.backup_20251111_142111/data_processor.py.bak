"""
ä¼ æ„Ÿå™¨æ•°æ®å¤„ç†å™¨ - å¤šæ¨¡å—ç‰ˆæœ¬

æ”¯æŒå¤šç§å›¾åƒå¤„ç†æ–¹æ³•:
  â€¢ SwinIR - åŸºäº Swin Transformer çš„å›¾åƒä¿®å¤ï¼ˆå»å™ªã€è¶…åˆ†è¾¨ç‡ã€JPEG ä¿®å¤ï¼‰
  â€¢ SRGAN - åŸºäº GAN çš„ 4x è¶…åˆ†è¾¨ç‡ / å›¾åƒå¢å¼º

ä½¿ç”¨æ–¹æ³•ï¼š
    from data_processor import SensorDataProcessor
    from data_processor_config import ACTIVE_CONFIG
    
    processor = SensorDataProcessor(ACTIVE_CONFIG)
    processed_rgb = processor.process_rgb(rgb_image)
"""

import sys
import os
import numpy as np
from pathlib import Path
import json

# æ·»åŠ å¤„ç†æ¨¡å—è·¯å¾„
SWINIR_PATH = '/home/nju/InterFuser/process_mothod/SwinIR'
SRGAN_PATH = '/home/nju/InterFuser/process_mothod/SRGAN'

if SWINIR_PATH not in sys.path:
    sys.path.insert(0, SWINIR_PATH)
if SRGAN_PATH not in sys.path:
    sys.path.insert(0, SRGAN_PATH)


class SensorDataProcessor:
    """ä¼ æ„Ÿå™¨æ•°æ®å¤„ç†å™¨ - æ”¯æŒå¤šç§å›¾åƒå¤„ç†æ–¹æ³•"""
    
    def __init__(self, config):
        """
        åˆå§‹åŒ–æ•°æ®å¤„ç†å™¨
        
        Args:
            config: é…ç½®å­—å…¸ï¼Œå‚è§ data_processor_config.py
        """
        self.config = config
        self.enabled = config.get('enabled', True)
        self.frame_count = 0
        self.stats = {
            'total_frames': 0,
            'rgb_processed': 0,
        }
        
        # åˆå§‹åŒ–å¤„ç†å™¨
        self.swinir_processor = None
        self.srgan_processor = None
        self.processor_type = 'none'
        
        if self.enabled:
            # æ£€æŸ¥é…ç½®çš„å¤„ç†å™¨ç±»å‹
            processor_type = config.get('processor_type', 'none')
            
            # åˆå§‹åŒ– SwinIR
            swinir_config = config.get('swinir', {})
            if swinir_config.get('enabled', False) or processor_type == 'swinir':
                self._init_swinir(swinir_config)
                self.processor_type = 'swinir'
            
            # åˆå§‹åŒ– SRGAN
            srgan_config = config.get('srgan', {})
            if srgan_config.get('enabled', False) or processor_type == 'srgan':
                self._init_srgan(srgan_config)
                self.processor_type = 'srgan'
        
        # æ‰“å°åˆå§‹åŒ–ä¿¡æ¯
        if self.enabled:
            print("\n" + "=" * 70)
            if self.swinir_processor:
                print("ğŸ–¼ï¸  SwinIR æ•°æ®å¤„ç†å™¨å·²åˆå§‹åŒ–")
                print("=" * 70)
                print(f"  ä»»åŠ¡: {swinir_config.get('task', 'color_dn')}")
                print(f"  æ¨¡å‹: {os.path.basename(swinir_config.get('model_path', 'N/A'))}")
                if swinir_config.get('task') in ['denoise', 'gray_dn', 'color_dn']:
                    print(f"  å™ªå£°ç­‰çº§: {swinir_config.get('noise', 15)}")
                if swinir_config.get('task') in ['jpeg', 'jpeg_car', 'color_jpeg_car']:
                    print(f"  JPEG è´¨é‡: {swinir_config.get('jpeg', 40)}")
            elif self.srgan_processor:
                print("ğŸ–¼ï¸  SRGAN æ•°æ®å¤„ç†å™¨å·²åˆå§‹åŒ–")
                print("=" * 70)
                print(f"  æ¨¡å‹: {os.path.basename(srgan_config.get('model_path', 'N/A'))}")
                output_scale = srgan_config.get('output_scale', 2)
                if output_scale == 1:
                    print(f"  æ¨¡å¼: å›¾åƒå¢å¼ºï¼ˆ1xï¼‰")
                elif output_scale == 2:
                    print(f"  æ¨¡å¼: 2x è¶…åˆ†è¾¨ç‡ï¼ˆä¸åŸå§‹ test.py ä¸€è‡´ï¼‰â­")
                elif output_scale == 4:
                    print(f"  æ¨¡å¼: 4x è¶…åˆ†è¾¨ç‡ï¼ˆå®Œæ•´æ”¾å¤§ï¼‰")
                else:
                    print(f"  æ¨¡å¼: {output_scale}x è¶…åˆ†è¾¨ç‡")
            else:
                print("â„¹ï¸   æ•°æ®å¤„ç†å™¨å·²åˆå§‹åŒ–ï¼ˆæ— å¤„ç†æ¨¡å¼ï¼‰")
                print("=" * 70)
            print("=" * 70 + "\n")
    
    def _init_swinir(self, swinir_config):
        """åˆå§‹åŒ– SwinIR å¤„ç†å™¨"""
        try:
            from swinir_wrapper import SwinIRProcessor
            
            model_path = swinir_config.get('model_path')
            if not model_path or not os.path.exists(model_path):
                print(f"âš ï¸  SwinIR æ¨¡å‹æ–‡ä»¶ä¸å­˜åœ¨: {model_path}")
                print("  è·³è¿‡ SwinIR åˆå§‹åŒ–")
                return
            
            self.swinir_processor = SwinIRProcessor(
                model_path=model_path,
                task=swinir_config.get('task', 'color_dn'),
                upscale=swinir_config.get('upscale', 1),
                device=swinir_config.get('device', 'cuda'),
                half_precision=swinir_config.get('half_precision', False),
                noise=swinir_config.get('noise', 15),
                jpeg=swinir_config.get('jpeg', 40),
                training_patch_size=swinir_config.get('training_patch_size', 128),
                tile=swinir_config.get('tile', None),
                tile_overlap=swinir_config.get('tile_overlap', 32)
            )
            
        except ImportError as e:
            print(f"âš ï¸  æ— æ³•å¯¼å…¥ SwinIR: {e}")
            print(f"  è¯·ç¡®ä¿ SwinIR åœ¨è·¯å¾„: {SWINIR_PATH}")
            self.swinir_processor = None
        except Exception as e:
            print(f"âš ï¸  SwinIR åˆå§‹åŒ–å¤±è´¥: {e}")
            self.swinir_processor = None
    
    def _init_srgan(self, srgan_config):
        """åˆå§‹åŒ– SRGAN å¤„ç†å™¨"""
        try:
            from srgan_wrapper import SRGANProcessor
            
            model_path = srgan_config.get('model_path')
            if not model_path or not os.path.exists(model_path):
                print(f"âš ï¸  SRGAN æ¨¡å‹æ–‡ä»¶ä¸å­˜åœ¨: {model_path}")
                print("  è·³è¿‡ SRGAN åˆå§‹åŒ–")
                return
            
            self.srgan_processor = SRGANProcessor(
                model_path=model_path,
                device=srgan_config.get('device', 'cuda'),
                half_precision=srgan_config.get('half_precision', False),
                output_scale=srgan_config.get('output_scale', 2),  # é»˜è®¤ 2xï¼ˆä¸åŸå§‹ test.py ä¸€è‡´ï¼‰
                large_kernel_size=srgan_config.get('large_kernel_size', 9),
                small_kernel_size=srgan_config.get('small_kernel_size', 3),
                n_channels=srgan_config.get('n_channels', 64),
                n_blocks=srgan_config.get('n_blocks', 16),
                scaling_factor=srgan_config.get('scaling_factor', 4)
            )
            
        except ImportError as e:
            print(f"âš ï¸  æ— æ³•å¯¼å…¥ SRGAN: {e}")
            print(f"  è¯·ç¡®ä¿ SRGAN åœ¨è·¯å¾„: {SRGAN_PATH}")
            self.srgan_processor = None
        except Exception as e:
            print(f"âš ï¸  SRGAN åˆå§‹åŒ–å¤±è´¥: {e}")
            self.srgan_processor = None
    
    def process_rgb(self, rgb_image, sensor_id='rgb'):
        """
        å¤„ç† RGB å›¾åƒ
        
        Args:
            rgb_image: numpy array, shape (H, W, 3), RGB æ ¼å¼, 0-255
            sensor_id: ä¼ æ„Ÿå™¨ IDï¼ˆæœªä½¿ç”¨ï¼Œä¿æŒæ¥å£å…¼å®¹ï¼‰
        
        Returns:
            å¤„ç†åçš„ RGB å›¾åƒï¼Œshape (H, W, 3), RGB æ ¼å¼, 0-255
        """
        if not self.enabled:
            return rgb_image
        
        # æ ¹æ®å¤„ç†å™¨ç±»å‹è¿›è¡Œå¤„ç†
        if self.processor_type == 'swinir' and self.swinir_processor:
            processed = self.swinir_processor.process(rgb_image)
        elif self.processor_type == 'srgan' and self.srgan_processor:
            processed = self.srgan_processor.process(rgb_image)
        else:
            # æ— å¤„ç†
            return rgb_image
        
        # æ›´æ–°ç»Ÿè®¡
        self.stats['rgb_processed'] += 1
        
        return processed
    
    def next_frame(self):
        """æ›´æ–°å¸§è®¡æ•°"""
        self.frame_count += 1
        self.stats['total_frames'] += 1
    
    def get_config_summary(self):
        """è·å–é…ç½®æ‘˜è¦"""
        summary = {
            'enabled': self.enabled,
        }
        
        if self.swinir_processor:
            swinir_stats = self.swinir_processor.get_stats()
            summary['swinir'] = swinir_stats
        
        return summary
    
    def print_stats(self):
        """æ‰“å°ç»Ÿè®¡ä¿¡æ¯"""
        print("\n" + "=" * 70)
        print("ğŸ“Š æ•°æ®å¤„ç†å™¨ç»Ÿè®¡ä¿¡æ¯")
        print("=" * 70)
        print(f"  æ€»å¸§æ•°: {self.stats['total_frames']}")
        print(f"  RGB å¤„ç†: {self.stats['rgb_processed']}")
        
        if self.swinir_processor:
            swinir_stats = self.swinir_processor.get_stats()
            print(f"\nSwinIR ç»Ÿè®¡:")
            print(f"  ä»»åŠ¡: {swinir_stats['task']}")
            print(f"  è®¾å¤‡: {swinir_stats['device']}")
            print(f"  å¤„ç†å¸§æ•°: {swinir_stats['process_count']}")
        
        print("=" * 70 + "\n")
    
    def save_stats(self, filepath):
        """ä¿å­˜ç»Ÿè®¡ä¿¡æ¯åˆ° JSON æ–‡ä»¶"""
        stats_data = {
            'stats': self.stats,
            'config_summary': self.get_config_summary()
        }
        
        with open(filepath, 'w') as f:
            json.dump(stats_data, f, indent=2)
        
        print(f"âœ… ç»Ÿè®¡ä¿¡æ¯å·²ä¿å­˜åˆ°: {filepath}")


# ä¸ºäº†å‘åå…¼å®¹ï¼Œä¿ç•™ä¸€äº›ç©ºçš„æ–¹æ³•
    def process_lidar(self, lidar_data):
        """ä¿æŒæ¥å£å…¼å®¹ï¼Œç›´æ¥è¿”å›åŸå§‹æ•°æ®"""
        return lidar_data
    
    def process_gps(self, gps_data):
        """ä¿æŒæ¥å£å…¼å®¹ï¼Œç›´æ¥è¿”å›åŸå§‹æ•°æ®"""
        return gps_data
    
    def process_speed(self, speed):
        """ä¿æŒæ¥å£å…¼å®¹ï¼Œç›´æ¥è¿”å›åŸå§‹æ•°æ®"""
        return speed
    
    def process_compass(self, compass):
        """ä¿æŒæ¥å£å…¼å®¹ï¼Œç›´æ¥è¿”å›åŸå§‹æ•°æ®"""
        return compass


if __name__ == "__main__":
    # ç®€å•æµ‹è¯•
    print("=" * 70)
    print("ğŸ§ª æµ‹è¯• SensorDataProcessor")
    print("=" * 70)
    
    # åˆ›å»ºæµ‹è¯•é…ç½®
    test_config = {
        'enabled': True,
        'swinir': {
            'enabled': False,  # é»˜è®¤å…³é—­ï¼Œå› ä¸ºéœ€è¦æ¨¡å‹æ–‡ä»¶
            'model_path': '/home/nju/InterFuser/process_mothod/SwinIR/model_zoo/swinir/005_colorDN_DFWB_s128w8_SwinIR-M_noise15.pth',
            'task': 'color_dn',
            'noise': 15,
        }
    }
    
    processor = SensorDataProcessor(test_config)
    
    # åˆ›å»ºæµ‹è¯•å›¾åƒ
    test_image = np.random.randint(0, 256, (100, 100, 3), dtype=np.uint8)
    print(f"\nè¾“å…¥å›¾åƒå½¢çŠ¶: {test_image.shape}")
    
    # å¤„ç†
    output = processor.process_rgb(test_image)
    print(f"è¾“å‡ºå›¾åƒå½¢çŠ¶: {output.shape}")
    
    # æ‰“å°ç»Ÿè®¡
    processor.next_frame()
    processor.print_stats()
    
    print("\n" + "=" * 70)
    print("âœ… æµ‹è¯•å®Œæˆ")
    print("=" * 70)
